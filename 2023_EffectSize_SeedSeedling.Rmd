---
title: "2023_effectsize_seedseedling"
output: html_document
date: "2023-03-18"
---

```{r}
rm(list=ls()) 
library(popbio)
library(popdemo)
library(ggplot2)
library(patchwork)
library(tidyr)
library(dplyr)    
library(lme4)
library(boot)
library(sjPlot)
library(MASS)

require(AICcmodavg)

library(R2jags)
library(runjags)
library(mcmcplots)
library(boot)


fi <- "blue"
si <- "brown"
fs <- "chartreuse4"
ss <- "goldenrod3"
  
# sampling from distribution, subtraction, report the mean and SD of differences
diffProb <- function(prob1, prob2){
  ## probs = confint(x) such that [1] is 2.5% and [2] is 97.5
  samp1 <- runif(1000, prob1[1], prob1[2])
  samp2 <- runif(1000, prob2[1], prob2[2])
  m.diff <- mean(samp1-samp2)
  sd.diff <- sd(samp1-samp2)
  data.frame(m.diff, sd.diff)
}  



```



### seed or seedlings, effect sizes of mode of reproduction, pace, and population size. 

```{r}

load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/plants_data2022-11-14.Rdata")
## Sample plants.seedbank asymptotic. 2022_SimulationDemoDistriubtion.Rmd   
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/Time2Ext_EP2022-11-05.Rdata")
## Sample plants.seedbank demographic stochastic (binomial and Poisson). 2022_SimulationDemoBinomialPoisson.Rmd
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/demostoch2022-11-15.Rdata")
## sample species with different matrices run simulataneously without demo stoch. 2022_SimulationEnvDistribution.Rmd
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/environ_portfolio2023-02-16.Rdata") # 2022-11-05.Rdata")
## Sample species and run all matrices of a life history within simultaneously with demo stoch
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/environ_portfolio_demo2022-11-15.Rdata")


Asymp <- Time2Ext_EP %>% ## Missing ShapeItero, need to pull shapeItero from plants.data
  mutate(simtype = "Asymptotic") %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(Time2Ext:LH, shapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class, simtype) %>%
  rename(ShapeItero = shapeItero) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 

demo <- demostoch %>% ## Missing ShapeItero, need to pull from plants.data
  mutate(simtype = "demoStoch") %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(Time2Ext:LH, shapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class, simtype) %>%
  rename(ShapeItero = shapeItero) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 

environdemo <- environ_portfolio_demo %>%
  mutate(simtype = "environdemo") %>%
  mutate(MatrixID = as.numeric(sapply(strsplit(MatrixID,"_"), `[`, 1))) %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(Time2Ext:LH, ShapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class, simtype) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 

environ <- environ_portfolio %>%
  mutate(simtype = "environ") %>%
  mutate(MatrixID = as.numeric(sapply(strsplit(MatrixID,"_"), `[`, 1))) %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(Time2Ext:LH, ShapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class, simtype) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 

ExtProb_all <- do.call(rbind, list(Asymp, demo, environdemo, environ))

ggplot(ExtProb_all, aes(LH, ShapeItero ))+
         geom_boxplot()



ExtProb_all <- ExtProb_all %>%
    dplyr::mutate(PopulationSizeScaled = scale(StPopSz)[,1],
                  ShapeIteroScaled = scale(ShapeItero)[,1],
                  AgeMatureScaled = scale(AgeMature)[,1]) %>%
  mutate(SpeciesAccepted = as.character(SpeciesAccepted)) %>%
  mutate(Family = as.character(Family)) %>%
  mutate(SpeciesAccepted = replace(SpeciesAccepted, SpeciesAccepted == "Silene Ciliata", "Silene ciliata")) %>%
  mutate(Family = replace(Family, Family == "Compositae", "Asteraceae")) %>%
  mutate(Family = replace(Family, Family == "Leguminosae", "Fabaceae")) %>%
  mutate(Family = replace(Family, Family == "Legumiosae", "Fabaceae")) %>% ## misspelling in Kummerowia striata family
  mutate(Family = replace(Family, Family == "Dipsacaceae", "Caprifoliaceae")) %>%
  mutate(Family = replace(Family, Family == "Fzcaceae", "Fucaceae")) %>%
  mutate(Family = replace(Family, Family == "Scropulariaceae", "Scrophulariaceae"))
```


```{r}
ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  filter(simtype %in% c("environdemo","environ")) %>%
  group_by(LH, start, simtype, StPopSz, Parity, Pace) %>%
  summarise(PE_10yrs = sum(!is.na(Time2Ext[Time2Ext < 11]))/n(), .groups = "keep") %>%
  mutate(label = paste0(start, "\n", LH)) %>%
ggplot(  aes(log(StPopSz), PE_10yrs, color = start, linetype = simtype))+
    geom_point()+
    geom_line()+
    theme_bw()+
  facet_grid(Parity ~ Pace)+
    ylab("Probability of Extinction after 10 years")+
    xlab("log(Starting population size)")+
  scale_color_manual("Start stage", values = c("brown","green"),
                     labels = c("Seed","Seedling"))+
  scale_linetype_manual("Simulation", values = c("solid","dotted"), 
                        labels = c("Environment","Env + Demo")) +
  ggtitle("Environmental and demographic variability")

pace_seed <- ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  filter(simtype %in% c("environdemo","environ")) %>%
    mutate(Ext_10yrs = case_when(Time2Ext <= 100 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 100 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Pace = case_when(LH %in% c("FI","FS") ~ "Fast",
                                LH %in% c("SI","SS") ~ "Slow")) %>%
  # group_by(LH, start, simtype, StPopSz, Parity, Pace) %>%
  # summarise(PE_10yrs = sum(!is.na(Time2Ext[Time2Ext < 11]))/n(), .groups = "keep") %>%
  mutate(label = paste0(start, "\n", LH)) %>%
    dplyr::mutate(PopulationSizeScaled = scale(StPopSz)[,1],
                  ShapeIteroScaled = scale(ShapeItero)[,1],
                  AgeMatureScaled = scale(AgeMature)[,1]) %>%
ggplot(  aes(ShapeItero, Ext_10yrs, color = start, linetype = simtype))+
    geom_point(shape = "|")+
    geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE, alpha = 0.5)+
    theme_bw()+
  facet_grid(Pace ~ StPopSz)+
    ylab("Probability of Extinction after 10 years")+
    xlab("Shape Reproduction scaled")+
  scale_color_manual("Start stage", values = c("brown","green"),
                     labels = c("Seed","Seedling"))+
  scale_linetype_manual("Simulation", values = c("solid","dotted"), 
                        labels = c("Environment","Env + Demo")) +
  ggtitle("Environmental and demographic variability")+
  geom_vline(xintercept = -0.4, linetype = "dashed", color = "black")+
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")+
  scale_x_continuous(breaks = c(-0.4, -0.3,-0.2,-0.1,0,0.1),
                     labels = c("late",-0.3,-0.2,-0.1,"even",0.1),
                     guide = guide_axis(angle=90))

parity_seed <- ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  filter(simtype %in% c("environdemo","environ")) %>%
    mutate(Ext_10yrs = case_when(Time2Ext <= 100 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 100 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Pace = case_when(LH %in% c("FI","FS") ~ "Fast",
                                LH %in% c("SI","SS") ~ "Slow")) %>%
  # group_by(LH, start, simtype, StPopSz, Parity, Pace) %>%
  # summarise(PE_10yrs = sum(!is.na(Time2Ext[Time2Ext < 11]))/n(), .groups = "keep") %>%
  mutate(label = paste0(start, "\n", LH)) %>%
    dplyr::mutate(PopulationSizeScaled = scale(StPopSz)[,1],
                  ShapeIteroScaled = scale(ShapeItero)[,1],
                  AgeMatureScaled = scale(AgeMature)[,1]) %>%
ggplot(  aes(ShapeItero, Ext_10yrs, color = start, linetype = simtype))+
    geom_point(shape = "|")+
    geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE, alpha = 0.5)+
    theme_bw()+
  facet_grid(Parity ~ StPopSz)+
    ylab("Probability of Extinction after 10 years")+
    xlab("Mode of Reproduction")+
  scale_color_manual("Start stage", values = c("brown","green"),
                     labels = c("Seed","Seedling"))+
  scale_linetype_manual("Simulation", values = c("solid","dotted"), 
                        labels = c("Environment","Env + Demo")) +
  ggtitle("Environmental and demographic variability")+
  geom_vline(xintercept = -0.4, linetype = "dashed", color = "black")+
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")+
  scale_x_continuous(breaks = c(-0.4, -0.3,-0.2,-0.1,0,0.1),
                     labels = c("late",-0.3,-0.2,-0.1,"even",0.1),
                     guide = guide_axis(angle=90))

```

```{r}
ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/SeedSeedling_paceparity",Sys.Date(),".jpg", sep=""),
       pace_seed/parity_seed, width=250, height=180,units='mm', dpi=300)


```


## make a time to extinction dataframe to use. 

```{r}
summarySeedSeedling <- ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  # filter(simtype %in% c("environdemo","environ")) %>%
  # filter(simtype %in% c("environdemo","demoStoch")) %>%
  # group_by(LH, start, simtype, StPopSz, Parity, Pace, Family) %>%
  filter(!is.na(ShapeItero)) %>%
    mutate(Ext_10yrs = case_when(Time2Ext <= 10 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 10 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Ext_30yrs = case_when(Time2Ext <= 30 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 30 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Ext_50yrs = case_when(Time2Ext <= 50 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 50 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Ext_100yrs = case_when(Time2Ext <= 100 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 100 | is.na(Time2Ext) ~ 0))

summarySeedSeedling_v2 <- ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  mutate(logStPopSz = log(StPopSz)) %>%
  mutate(StPopSz = scale(StPopSz)[,1]) %>%
  filter(simtype %in% c("environdemo","environ")) %>%
  # filter(simtype %in% c("environdemo","demoStoch")) %>%
  mutate(Ext_10yrs = case_when(Time2Ext <= 10 & !is.na(Time2Ext) ~ 1,
                               Time2Ext > 10 | is.na(Time2Ext) ~ 0)) %>%
  mutate(Ext_30yrs = case_when(Time2Ext <= 30 & !is.na(Time2Ext) ~ 1,
                               Time2Ext > 30 | is.na(Time2Ext) ~ 0)) %>%
  mutate(Ext_50yrs = case_when(Time2Ext <= 50 & !is.na(Time2Ext) ~ 1,
                               Time2Ext > 50 | is.na(Time2Ext) ~ 0)) %>%
  mutate(Ext_100yrs = case_when(Time2Ext <= 100 & !is.na(Time2Ext) ~ 1,
                               Time2Ext > 100 | is.na(Time2Ext) ~ 0))
```


Actually would want to compare the impact of environmental stochasticity alone to both since environmental increases risk
```{r}  
pointEsts <- ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  filter(simtype %in% c("environdemo","environ")) %>%
  # filter(simtype %in% c("environdemo","demoStoch")) %>%
  group_by(LH, start, simtype, StPopSz, Parity, Pace) %>%
  summarise(PE_10yrs = sum(!is.na(Time2Ext[Time2Ext < 11]))/n(), .groups = "keep") %>%
  mutate(label = paste0(start, "\n", LH))
### visualize 
summarySeedSeedling %>%
  ggplot(  aes(log(StPopSz), Ext_10yrs, color = start, linetype = simtype))+
    geom_point(data = pointEsts, aes(log(StPopSz), PE_10yrs))+
    geom_line(data = pointEsts, aes(log(StPopSz), PE_10yrs))+
    facet_grid(Parity~Pace)+
  ylab("Extinction by 10 years")+
  xlab("Mode of Reproduction")+
    geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE, alpha = 0.5)+
    theme_bw()+
  scale_color_manual("Start stage", values = c("brown","darkgreen"),
                     labels = c("Seed","Seedling"))+
  scale_linetype_manual("Simulation", values = c("solid","dotted"), 
                        labels = c("Environment","Env + Demo")) +
  ggtitle("Environmental and demographic variability")


### Better to show the points and HDI or confint around
```


10 years Categorical Pace and parity
```{r}
# specify model in BUGS language   
model10yearSeed <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] +                     ## Random effect of family
                            bPace[Pace[i]] +                      ## Pace: fast age of rep < 3yrs or slow age of rep 3+
                            bParity[Parity[i]] +                  ## Parity: iteroparous 3+ yrs rep, semelparous <3 yrs
                            bStoch[simtype[i]] +                  ## stochasticity: Asymptotic, demographic, [1] environ [2] environdemo 
                            bStPopSz * StPopSz[i] +               ## founding population size: 1,10,50,100,1000
                            bStage[start[i]] +                    ## founding population stage: seed, seedling 
                            ## Interactions
                            bPaceXParity[Pace[i],Parity[i]] +
                            bPaceXStoch[Pace[i],simtype[i]] +
                            bPaceXStPopSz[Pace[i]] * StPopSz[i] + 
                            bPaceXStage[Pace[i],start[i]] +
                            
                            bParityXStoch[Parity[i],simtype[i]] +
                            bParityXStPopSz[Parity[i]] * StPopSz[i] + 
                            bParityXStage[Parity[i],start[i]] +
                            
                            bStageXStoch[start[i],simtype[i]] +
                            bStageXStPopSz[start[i]] * StPopSz[i] +
                            
                            bStPopSzXStoch[simtype[i]] * StPopSz[i]
                            
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        for(i in 1:2){
          Paritytemp[i] ~ dnorm(0, 0.01)
        }
        bParity <- Paritytemp - mean(Paritytemp) ## change in centered Pace
                
        for(i in 1:4){
          simtypetemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- simtypetemp - mean(simtypetemp)

        for(i in 1:2){
          Stagetemp[i] ~ dnorm(0, 0.01)
        }
        bStage <- Stagetemp - mean(Stagetemp)
        
        for(i in 1:2){
          for(j in 1:2){
            PaceParitytemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bPaceXParity <- PaceParitytemp - mean(PaceParitytemp)
        
        for(i in 1:2){
          for(j in 1:4){
            bPaceXStochtemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXStoch <- bPaceXStochtemp - mean(bPaceXStochtemp)

        for(i in 1:2){
          for(j in 1:2){
            bParityXStochtemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bParityXStoch <- bParityXStochtemp - mean(bParityXStochtemp)
        
        for(i in 1:2){
          for(j in 1:2){
            PaceStagetemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bPaceXStage <- PaceStagetemp - mean(PaceStagetemp)
        
        
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          PaceXShapetemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        for(i in 1:2){
          ParityXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bParityXStPopSz <- ParityXStPopSztemp - mean(ParityXStPopSztemp)
        
        for(i in 1:2){
          for(j in 1:2){
            ParityStagetemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bParityXStage <- ParityStagetemp - mean(ParityStagetemp)
         
        for(i in 1:2){
          for(j in 1:2){
            StageXStochtemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bStageXStoch <- StageXStochtemp - mean(StageXStochtemp)
        
        for(i in 1:2){
          StageXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bStageXStPopSz <- StageXStPopSztemp - mean(StageXStPopSztemp)
        
        for(i in 1:2){
          StPopSzXStochtemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStoch <- StPopSzXStochtemp - mean(StPopSzXStochtemp)
        
        bStPopSz ~ dunif(-3,3)
        
        }")
writeLines(model10yearSeed, "popsize10yrsFamilyseed.jags")


# sampleSeed <- summarySeedSeedling_v2[sample(1:nrow(summarySeedSeedling_v2), 10000, replace = FALSE),]
# sampleSeed$Family <- droplevels(as.factor(sampleSeed$Family))
# jags.dataseed <- list(y = sampleSeed$Ext_10yrs, N = nrow(sampleSeed),
#                   nFam = length(unique(sampleSeed$Family)),
#                   fam = sampleSeed$Family,
#                   StPopSz = sampleSeed$StPopSz,                            ## continuous, log-transformed
#                   Pace = as.factor(sampleSeed$Pace),                       ## [1] fast [2] slow
#                   Parity = as.factor(sampleSeed$Parity),                   ## [1] itero [2] semel
#                   start = as.factor(sampleSeed$start),                     ## [1] seed [2] seedling
#                   simtype = as.factor(sampleSeed$simtype))                 ## [1] environ [2] environdemo
jags.dataseed <- list(y = summarySeedSeedling_v2$Ext_10yrs, N = nrow(summarySeedSeedling_v2),
                  nFam = length(unique(summarySeedSeedling_v2$Family)),
                  fam = as.factor(summarySeedSeedling_v2$Family),
                  StPopSz = summarySeedSeedling_v2$StPopSz,
                  Pace = as.factor(summarySeedSeedling_v2$Pace),
                  Parity = summarySeedSeedling_v2$ParityScaled,
                  simtype = as.factor(summarySeedSeedling_v2$simtype))       ## [1] Asymptotic [2] demo [3] environ [4] environdemo

## parameters monitored
parameters <- c("bPace","bParity","bStoch","bStPopSz","bStage",
                "bPaceXParity","bPaceXStoch","bPaceXStPopSz","bPaceXStage",
                "bParityXStoch","bParityXStPopSz","bParityXStage",
                "bStageXStoch","bStageXStPopSz",
                "bStPopSzXStoch")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res10seed <- jags(jags.dataseed, inits = NULL, parameters, 
            "popsize10yrsFamilyseed.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 
## misnamed res100
save(res10seed, file = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/binomialFamRndm10yrs_seed",Sys.Date(),"..Rdata", sep=""))
print(res10seed, digits = 3)
## Check convergence 
# trace plots
traplot(res10seed, c("bPace","bParity","bStoch","bStPopSz","bStage",
                "bPaceXParity","bPaceXStoch","bPaceXStPopSz","bPaceXStage",
                "bParityXStoch","bParityXStPopSz","bParityXStage",
                "bStageXStoch","bStageXStPopSz",
                "bStPopSzXStoch"))
# posterior distributions
denplot(res10seed, c("bPace","bParity","bStoch","bStPopSz","bStage",
                "bPaceXParity","bPaceXStoch","bPaceXStPopSz","bPaceXStage",
                "bParityXStoch","bParityXStPopSz","bParityXStage",
                "bStageXStoch","bStageXStPopSz",
                "bStPopSzXStoch"))

## pace no difference 
denplot(res100, c("bPace"))

## stochastic 
denplot(res100, c("bStoch"))

## Population size
denplot(res100, c("bParityXStPopSz","bStPopSzXStoch"))  

denplot(res100, c("bStPopSz")) ## reduction in extinction risk as population size increase
```


10 year seed with continuous shape reproduction
## Test a JAGS mixed effects run    
```{r}
# specify model in BUGS language   
model10yrSeedShape <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] + 
            
                            bPace[Pace[i]] +                      ## Pace: fast age of rep < 3yrs or slow age of rep 3+
                            bStPopSz * StPopSz[i] +  ## scaled and centered, 1, 10, 50, 100, 1000
                            bShapeItero * shapeI[i] +             ## ShapeItero: -0.5 to 0.5, scaled and centered
                            bStage[start[i]] +                    ## founding population stage: seed, seedling                    
                            bStoch[simtype[i]] +                  ## stochasticity: Asymptotic, demographic, [1] environ [2] environdemo
                            
                            bPaceXStPopSz[Pace[i]] * StPopSz[i] +
                            bPaceXShape[Pace[i]] * shapeI[i] +
                            bPaceXStage[Pace[i],start[i]] + 
                            bPaceXStoch[Pace[i],simtype[i]] +
                            
                            bStPopSzXShape * StPopSz[i] * shapeI[i] +
                            bStPopSzXStart[start[i]] * StPopSz[i] +
                            bStPopSzXStoch[simtype[i]] * StPopSz[i] +
                            
                            bShapeXStart[start[i]] * shapeI[i] +
                            bShapeXStoch[simtype[i]] * shapeI[i] +
                            
                            bStageXStoch[start[i],simtype[i]]
                            
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
                
        bStPopSz ~ dunif(-3,3)
        
        bShapeItero ~ dunif(-3,3)
        
        ## stage seed, seedling
        for(i in 1:2){
          stagetemp[i] ~ dnorm(0, 0.01)
        }
        bStage <- stagetemp - mean(stagetemp)
        
        for(i in 1:4){
          Starttemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- Starttemp - mean(Starttemp) 
        
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          PaceXShapetemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        for(i in 1:2){
          for(j in 1:2){
            PaceStagetemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bPaceXStage <- PaceStagetemp - mean(PaceStagetemp)
        
        for(i in 1:2){
          for(j in 1:4){
            bPaceXStochtemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXStoch <- bPaceXStochtemp - mean(bPaceXStochtemp)

        bStPopSzXShape ~ dunif(-5,5)
        
        for(i in 1:2){
          bStSttemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStart <- bStSttemp - mean(bStSttemp)
                
        for(i in 1:4){
          StPopSzXStochtemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStoch <- StPopSzXStochtemp - mean(StPopSzXStochtemp)
        
        for(i in 1:2){
          bShSttemp[i] ~ dnorm(0, 0.01)
        }
        bShapeXStart <- bShSttemp - mean(bShSttemp)
        
        for(i in 1:4){
          bShStochtemp[i] ~ dnorm(0, 0.01)
        }
        bShapeXStoch <- bShStochtemp - mean(bShStochtemp)
        
        for(i in 1:2){
          for(j in 1:4){
            stagestoch[i,j] ~ dnorm(0, 0.01)
          }
        }
        bStageXStoch <- stagestoch - mean(stagestoch)
      
      }")
writeLines(model10yrSeedShape, "popsize10yrSeedShape.jags")

sumSeedSeedling <- summarySeedSeedling_v2 %>%
  filter(!is.na(ShapeItero))
jags.data <- list(y = sumSeedSeedling$Ext_10yrs, N = nrow(sumSeedSeedling),
                  nFam = length(unique(sumSeedSeedling$Family)),
                  fam = as.factor(sumSeedSeedling$Family),
                  StPopSz = sumSeedSeedling$PopulationSizeScaled,
                  Pace = as.factor(sumSeedSeedling$Pace),
                  start = as.factor(sumSeedSeedling$start),
                  shapeI = sumSeedSeedling$ShapeIteroScaled,
                  simtype = as.factor(sumSeedSeedling$simtype))

## parameters monitored
parameters <- c("bPace","bStPopSz","bShapeItero","bStoch","bStage",
                "bPaceXStPopSz","bPaceXShape","bPaceXStage","bPaceXStoch",
                "bStPopSzXStart","bStPopSzXShape","bStPopSzXStoch",
                "bShapeXStart","bShapeXStoch",
                "bStageXStoch")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res10seedshape <- jags(jags.data, inits = NULL, parameters, 
            "popsize10yrSeedShape.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 

save(res10seedshape, file = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/binomialFamRndm10yrSeedShape",Sys.Date(),".Rdata", sep=""))
print(res10seedshape, digits = 3)
## Check convergence 
# trace plots
traplot(res10seedshape,c("bPace","bStPopSz","bShapeItero","bStoch","bStage",
                "bPaceXStPopSz","bPaceXShape","bPaceXStage","bPaceXStoch",
                "bStPopSzXStart","bStPopSzXShape","bStPopSzXStoch",
                "bShapeXStart","bShapeXStoch",
                "bStageXStoch"))
# posterior distributions
denplot(res10seedshape,c("bPace","bStPopSz","bShapeItero","bStoch","bStage",
                "bPaceXStPopSz","bPaceXShape","bPaceXStage","bPaceXStoch",
                "bStPopSzXStart","bStPopSzXShape","bStPopSzXStoch",
                "bShapeXStart","bShapeXStoch",
                "bStageXStoch"))
```



summarySeedSeedling and _v2 are the same; mutate and group by did nothing different without the group_by
```{r}
## Can compare across shapeItero as well, AIC for shapeItero and 
summarySeedSeedling_v2 <- summarySeedSeedling_v2 %>%
  mutate(Pace = as.factor(Pace),
         Parity = as.factor(Parity),
         start = as.factor(start),
         simtype = as.factor(simtype))

# glm1 <- glm(Ext_10yrs ~ (Parity + Pace + StPopSz + start + simtype)^2, 
#                 family = binomial, data = summarySeedSeedling_v2[,c("Ext_10yrs","Parity","Pace","StPopSz","start","simtype")])
# glm1sum <- summary(glm1)
# confintseedseedling <- confint(glm1)

glm1seedrandom <- glmer(Ext_10yrs ~ (Parity + Pace + StPopSz + start + simtype)^2 + (1|Family), 
                family = binomial, 
          # control = glmerControl(optimizer ="Nelder_Mead"),
          control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)),
          data = summarySeedSeedling_v2[,c("Ext_10yrs","Parity","Pace","StPopSz","start","simtype","Family")])
glm1sumseedrandom <- summary(glm1seedrandom)


## nested random, that the life histories are mostly the same across species but not because of phylogenetic relationships
glm1_sp <- glmer(Ext_10yrs ~ (Parity + Pace + StPopSz + start + simtype)^2 + (1|LH/SpeciesAccepted), 
                family = binomial, 
                data = summarySeedSeedling_v2[,c("Ext_10yrs","Parity","Pace","StPopSz","start","simtype","SpeciesAccepted")])


glm1_order <- glmer(Ext_10yrs ~ Parity + Pace + StPopSz + start + simtype + (1|Order), 
                family = binomial, 
                data = summarySeedSeedling_v2[,c("Ext_10yrs","Parity","Pace","StPopSz","start","simtype","Order")])

glm1_family <- glmer(Ext_10yrs ~ (Parity + Pace + StPopSz + start)^2 + simtype + (1|LH/Family), 
                family = binomial, 
                data = summarySeedSeedling_v2[,c("Ext_10yrs","Parity","Pace","StPopSz","start","simtype","Family","LH")])

glm.list <- list(glm1,glm1_family)
glm.names <- as.character(unlist(lapply(glm.list,formula)))
(glm.results <- aictab(glm.list, modnames=glm.names))


newdataseedseedling <- unique(expand.grid(simtype = unique(summarySeedSeedling$simtype),
                                          StPopSz = unique(summarySeedSeedling_v2$StPopSz)[c(1,3,5)],
                                   Parity = unique(summarySeedSeedling$Parity),
                                   Pace = unique(summarySeedSeedling$Pace),
                                   start = summarySeedSeedling$start))

newdataseedseedling$fit <- predict(glm1, newdataseedseedling, type = "response", se.fit = TRUE)$fit ## "f log-odds (probabilities 
#on logit scale) and type = "response" gives the predicted probabilities" Don't need plogis!!! 
# newdataseedseedling$probExt <- plogis(newdataseedseedling$fit)
newdataseedseedling$fit.se <- predict(glm1, newdataseedseedling, type = "response", se.fit = TRUE)$se.fit 

## output table
outTable4 <- newdataseedseedling %>%
  group_by(Parity, simtype, start, StPopSz, Pace) %>%
  summarise(Prob_SE = paste(round(fit,4)*100,"% (",round(fit.se,4)*100,"%)",sep = ""))%>%
  print(n = 48)


popszF1EI_S1EI <- diffProb(plogis(colSums(confintseedseedling[c('(Intercept)','StPopSz'),])),
                           plogis(colSums(confintseedseedling[c('(Intercept)','Paceslow','StPopSz'),])))


popszF1EDS <- diffProb(plogis(colSums(confintseedseedling[c('(Intercept)','simtypeenvirondemo','Paritysemel','StPopSz'),])),
                      plogis(colSums(confintseedseedling[c('(Intercept)','simtypeenvirondemo','Paritysemel'),])))

popszS1EDI <- diffProb(plogis(colSums(confintseedseedling[c('(Intercept)','simtypeenvirondemo',
                                                           'Paceslow','StPopSz'),])),
                      plogis(colSums(confintseedseedling[c('(Intercept)','simtypeenvirondemo',
                                                           'Paceslow'),])))

popszF1EDI <- diffProb(plogis(colSums(confintseedseedling[c('(Intercept)','simtypeenvirondemo','StPopSz'),])),
                      plogis(colSums(confintseedseedling[c('(Intercept)','simtypeenvirondemo'),])))




# Difference of seed - seedling on rate of change in extinction risk [ ignore pop size for now ] by increasing population size
## Fast Iteroparous, increasing population size and switching from seedling to seed 
diffProb(plogis(colSums(confintseedseedling[c('(Intercept)','startseedling'),])),  # ,'StPopSz'
         plogis(colSums(confintseedseedling[c('(Intercept)'),])) #Fast, Itero, Seed
         ) # Bigger numbers for seed, 
         
## Slow iteroparous
diffProb(plogis(colSums(confintseedseedling[c('(Intercept)','StPopSz','Paceslow'),])), #Slow, Itero, Seed
         plogis(colSums(confintseedseedling[c('(Intercept)','startseedling','StPopSz','Paceslow'),]))) # #Slow, Itero, Seedling         
  


```





## For Julie Young presentation  
```{r}
ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  group_by(LH, start, simtype, StPopSz, Parity, Pace) %>%
    mutate(Ext_10yrs = case_when(Time2Ext <= 10 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 10 | is.na(Time2Ext) ~ 0)) %>%
  mutate(label = paste0(start, "\n", LH)) %>%
ggplot(  aes(log(StPopSz), Ext_10yrs, color = simtype))+ 
    geom_smooth(method = "glm", method.args = list(family = "binomial"),se = FALSE, alpha = 0.95)+
    theme_bw()+
  facet_wrap(~start)+
    ylab("Probability of Extinction after 10 years")+
    xlab("log(Starting population size)")+
  scale_color_manual("Simulation", values = c("blue3","darkgoldenrod1","brown2","darkseagreen4"),
                        labels = c("Asymptotic" = "Asymptotic",
                                   "demoStoch" = "Demographic",
                                   "environ" = "Environment",
                                   "environdemo"  = "Env + Demo")) 

```


```{r}
## Probability of extinction across population size 
ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  group_by(LH, start, simtype, StPopSz, Parity, Pace) %>%
    mutate(Ext_10yrs = case_when(Time2Ext <= 10 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 10 | is.na(Time2Ext) ~ 0)) %>%
  mutate(label = paste0(start, "\n", LH)) %>%
ggplot(  aes(log(StPopSz), Ext_10yrs, color = simtype))+
    geom_smooth(method = "glm", method.args = list(family = "binomial"),se = FALSE, alpha = 0.95)+
    theme_bw()+
  # facet_grid(Parity ~ Pace)+
  facet_grid(Pace~start)+
    ylab("Probability of Extinction after 10 years")+
    xlab("log(Starting population size)")+
  scale_color_manual("Simulation", values = c("blue3","darkgoldenrod1","brown2","darkseagreen4"),
                        labels = c("Asymptotic" = "Asymptotic",
                                   "demoStoch" = "Demographic",
                                   "environ" = "Environment",
                                   "environdemo"  = "Env + Demo")) 

### prob ext aross pop size, by life history category
ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  group_by(LH, start, simtype, StPopSz, Parity, Pace) %>%
    mutate(Ext_10yrs = case_when(Time2Ext <= 10 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 10 | is.na(Time2Ext) ~ 0)) %>%
  mutate(label = paste0(start, "\n", LH)) %>%
  filter(simtype %in% "environdemo") %>%
ggplot(  aes(log(StPopSz), Ext_10yrs, color = LH))+
    geom_smooth(method = "glm", method.args = list(family = "binomial"),se = FALSE, alpha = 0.95)+
    theme_bw()+
  # facet_grid(Parity ~ Pace)+
  facet_grid(~start)+
    ylab("Probability of Extinction after 10 years")+
    xlab("log(Starting population size)")+
  scale_color_manual("Category", values = c("blue3","darkgoldenrod1","brown2","darkseagreen4"),
                        labels = c("FI" = "fast itero",
                                   "FS" = "fast semel",
                                   "SI" = "slow itero",
                                   "SS"  = "slow semel")) +
  ggtitle("Environmental and demogrographic stochasticity")


## log odds of probability of extinction of seed compared to seedlings
ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  # filter(simtype %in% c("environdemo","environ")) %>%
  group_by(LH, start, simtype, StPopSz, Parity, Pace) %>%
  summarise(PE_10yrs = sum(!is.na(Time2Ext[Time2Ext < 11]))/n(), .groups = "keep") %>%
  group_by(LH, simtype, StPopSz, Parity, Pace) %>%
  summarise(lnEffSz = log(PE_10yrs[start == "seed"]) - log(PE_10yrs[start == "seedling"]+0.0001)) %>% ## Inf when Zero% extinction
  # mutate(label = paste0(start, "\n", LH)) %>%
ggplot(  aes(log(StPopSz), lnEffSz, color = simtype))+
    geom_point()+
    geom_line()+
    theme_bw()+
    geom_hline(yintercept = 1)+
  facet_grid(Parity ~ Pace)+
    ylab("log(Probability of Extinction) ratio seed:seedlings")+
    xlab("log(Starting population size)") +
  scale_color_manual("Simulation", values = c("blue3","darkgoldenrod1","brown2","darkseagreen4"),
                        labels = c("Asymptotic" = "Asymptotic",
                                   "demoStoch" = "Demographic",
                                   "environ" = "Environment",
                                   "environdemo"  = "Env + Demo")) 

## log odds of probability of extinction of seed compared to seedlings, just pace, no parity
ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  # filter(simtype %in% c("environdemo","environ")) %>%
  group_by(start, simtype, StPopSz,  Pace) %>%
  summarise(PE_10yrs = sum(!is.na(Time2Ext[Time2Ext < 11]))/n(), .groups = "keep") %>%
  group_by(simtype, StPopSz,  Pace) %>%
  summarise(lnEffSz = log(PE_10yrs[start == "seed"]) - log(PE_10yrs[start == "seedling"]+0.0001)) %>% ## Inf when Zero% extinction
  # mutate(label = paste0(start, "\n", LH)) %>%
ggplot(  aes(log(StPopSz), lnEffSz, color = simtype))+
    geom_point()+
    geom_line()+
    theme_bw()+
    geom_hline(yintercept = 1)+
  facet_grid( ~ Pace)+
    ylab("log(Probability of Extinction) ratio seed:seedlings")+
    xlab("log(Starting population size)") +
  scale_color_manual("Simulation", values = c("blue3","darkgoldenrod1","brown2","darkseagreen4"),
                        labels = c("Asymptotic" = "Asymptotic",
                                   "demoStoch" = "Demographic",
                                   "environ" = "Environment",
                                   "environdemo"  = "Env + Demo"))
```



# AIC of mulitple models  test with sample  
```{r}
set.seed(232323)

# specify model in BUGS language   
model10year <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] + 
                            bPace[fs[i]] + 
                            bStoch[start[i]] + 
                            bStPopSz * PopulationSizeScaled[i] +
                            bShapeItero * shapeI[i] +
                            bPaceXStPopSz[fs[i]] * PopulationSizeScaled[i] +
                            bPaceXShape[fs[i]] * shapeI[i] +
                            bPaceXstart[fs[i],start[i]] +
                            bStPopSzXShape * PopulationSizeScaled[i] * shapeI[i] +
                            bStPopSzXStart[start[i]] * PopulationSizeScaled[i] +
                            bShapeXStart[start[i]] * shapeI[i]
                            
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        ## also index for the interactions!
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          PaceXShapetemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        
        for(i in 1:4){
          Starttemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- Starttemp - mean(Starttemp)
        

        for(i in 1:2){
          for(j in 1:4){
            bPaceXstarttemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXstart <- bPaceXstarttemp - mean(bPaceXstarttemp)
        
        # bStPopSzXStart
        for(i in 1:4){
          bStSttemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStart <- bStSttemp - mean(bStSttemp)
        
        # bShapeXStart
        for(i in 1:4){
          bShSttemp[i] ~ dnorm(0, 0.01)
        }
        bShapeXStart <- bShSttemp - mean(bShSttemp)
        
        bStPopSz ~ dunif(-3,3)
        bShapeItero ~ dunif(-3,3)
        bStPopSzXShape ~ dunif(-5,5)
        
        }")
writeLines(model10year, "popsize10yrsFamily.jags")


sampleSumSim <- summarySimulations[sample(1:nrow(summarySimulations), 1000, replace = FALSE),]
sampleSumSim$Family <- droplevels(as.factor(sampleSumSim$Family))
jags.data <- list(y = sampleSumSim$Ext_10yrs, N = nrow(sampleSumSim),
                  nFam = length(unique(sampleSumSim$Family)),
                  fam = sampleSumSim$Family,
                  PopulationSizeScaled = sampleSumSim$PopulationSizeScaled, fs = as.factor(sampleSumSim$Pace),
                  shapeI = sampleSumSim$ShapeIteroScaled,
                  start = as.factor(sampleSumSim$start))
# jags.data <- list(y = summarySimulations$Ext_10yrs, N = nrow(summarySimulations),
#                   nFam = length(unique(summarySimulations$Family)),
#                   fam = as.factor(summarySimulations$Family),
#                   PopulationSizeScaled = summarySimulations$PopulationSizeScaled,
#                   fs = as.factor(summarySimulations$Pace),
#                   shapeI = summarySimulations$ShapeIteroScaled,
#                   start = as.factor(summarySimulations$start))

## parameters monitored
parameters <- c("bPace","bStPopSz","bShapeItero","bStoch",
                "bPaceXStPopSz","bPaceXShape","bPaceXstart","bShapeXStart",
                "bStPopSzXStart","bStPopSzXShape")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res <- jags(jags.data, inits = NULL, parameters, 
            "popsize10yrsFamily.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 

save(res, file = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/binomialFamRndm10yrs_SSD",Sys.Date(),"..Rdata", sep=""))
print(res, digits = 3)
## Check convergence 
# trace plots
traplot(res,c("bPace","bStPopSz","bShapeItero","bStoch","bPaceXStPopSz","bPaceXShape","bStPopSzXShape","bPaceXstart","bStPopSzXStart"))
# posterior distributions
denplot(res,c("bPace","bStPopSz","bShapeItero","bStoch","bPaceXStPopSz","bPaceXShape","bStPopSzXShape","bPaceXstart","bStPopSzXStart"))

dic.pd <- dic.samples(res$model, 1000, "pD") ## differs from before, has NA warning error
```

loglik_full <- jags.fit1$sims.list$LogLik
loglik_red <- jags.fit2$sims.list$LogLik

waic_full <- waic(loglik_full)

No interaction model
```{r}
set.seed(232323)

# specify model in BUGS language   
model10yearnointer <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] + 
                            bPace[fs[i]] + 
                            bStoch[start[i]] + 
                            bStPopSz * PopulationSizeScaled[i] +
                            bShapeItero * shapeI[i] 
                            # bPaceXStPopSz[fs[i]] * PopulationSizeScaled[i] +
                            # bPaceXShape[fs[i]] * shapeI[i] +
                            # bPaceXstart[fs[i],start[i]] +
                            # bStPopSzXShape * PopulationSizeScaled[i] * shapeI[i] +
                            # bStPopSzXStart[start[i]] * PopulationSizeScaled[i] +
                            # bShapeXStart[start[i]] * shapeI[i]
                            
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        ## also index for the interactions!
        # for(i in 1:2){
        #   PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        # }
        # bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        # for(i in 1:2){
        #   PaceXShapetemp[i] ~ dnorm(0, 0.01)
        # }
        # bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        
        for(i in 1:4){
          Starttemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- Starttemp - mean(Starttemp)
        

        # for(i in 1:2){
        #   for(j in 1:4){
        #     bPaceXstarttemp[i,j] ~ dnorm(0, 0.01)
        #   }
        # }
        # bPaceXstart <- bPaceXstarttemp - mean(bPaceXstarttemp)
        
        # bStPopSzXStart
        # for(i in 1:4){
        #   bStSttemp[i] ~ dnorm(0, 0.01)
        # }
        # bStPopSzXStart <- bStSttemp - mean(bStSttemp)
        
        # # bShapeXStart
        # for(i in 1:4){
        #   bShSttemp[i] ~ dnorm(0, 0.01)
        # }
        # bShapeXStart <- bShSttemp - mean(bShSttemp)
        
        bStPopSz ~ dunif(-3,3)
        bShapeItero ~ dunif(-3,3)
        # bStPopSzXShape ~ dunif(-5,5)
        
        }")
writeLines(model10yearnointer, "popsize10yrsFamilynointer.jags")


sampleSumSim <- summarySimulations[sample(1:nrow(summarySimulations), 1000, replace = FALSE),]
sampleSumSim$Family <- droplevels(as.factor(sampleSumSim$Family))
jags.data <- list(y = sampleSumSim$Ext_10yrs, N = nrow(sampleSumSim),
                  nFam = length(unique(sampleSumSim$Family)),
                  fam = sampleSumSim$Family,
                  PopulationSizeScaled = sampleSumSim$PopulationSizeScaled, fs = as.factor(sampleSumSim$Pace),
                  shapeI = sampleSumSim$ShapeIteroScaled,
                  start = as.factor(sampleSumSim$start))
# jags.data <- list(y = summarySimulations$Ext_10yrs, N = nrow(summarySimulations),
#                   nFam = length(unique(summarySimulations$Family)),
#                   fam = as.factor(summarySimulations$Family),
#                   PopulationSizeScaled = summarySimulations$PopulationSizeScaled,
#                   fs = as.factor(summarySimulations$Pace),
#                   shapeI = summarySimulations$ShapeIteroScaled,
#                   start = as.factor(summarySimulations$start))

## parameters monitored
parameters <- c("bPace","bStPopSz","bShapeItero","bStoch",
                "bPaceXStPopSz","bPaceXShape","bPaceXstart","bShapeXStart",
                "bStPopSzXStart","bStPopSzXShape")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res1 <- jags(jags.data, inits = NULL, parameters, 
            "popsize10yrsFamilynointer.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 

save(res1, file = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/binomialFamRndm10yrs_SSD_nointeraction",Sys.Date(),"..Rdata", sep=""))
print(res1, digits = 3)
## Check convergence 
# trace plots
traplot(res1,c("bPace","bStPopSz","bShapeItero","bStoch","bPaceXStPopSz","bPaceXShape","bStPopSzXShape","bPaceXstart","bStPopSzXStart"))
# posterior distributions
denplot(res1,c("bPace","bStPopSz","bShapeItero","bStoch","bPaceXStPopSz","bPaceXShape","bStPopSzXShape","bPaceXstart","bStPopSzXStart"))

dic.pd <- dic.samples(res1$model, 1000, "pD") ## differs from before, has NA warning error
```
