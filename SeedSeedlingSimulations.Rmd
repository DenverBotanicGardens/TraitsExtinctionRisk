---
title: "Compare asymtotic demo env"
author: "Michelle DePrenger-Levin"
date: "2022-10-25"
output: html_document
---
TraitsER
## Categorical pace and parity
Stage [Seed]  [Seedling]

Compare the impact of founding population size, founding population stage, pace (categorized), and parity (categorized), on extinction risk with asymptotic, demographic, environmental, and demo + envion stochasticity.


```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(patchwork)


load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/plants_data2022-11-14.Rdata")

## Sample plants.seedbank asymptotic 
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/Time2Ext_EP2022-11-05.Rdata")

## Sample plants.seedbank demographic stochastic (binomial and Poisson)
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/demostoch2022-11-15.Rdata")

## sample species with different matrices run simulataneously without demo stoch
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/environ_portfolio2022-11-05.Rdata")

## Sample species and run all matrices of a life history within simultaneously with demo stoch
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/environ_portfolio_demo2022-11-15.Rdata")

Asymp <- Time2Ext_EP %>%
  mutate(simtype = "Asymptotic") %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(c(Time2Ext:DegreeItero.x, shapeItero, AgeMature, simtype, SpeciesAccepted, Family, Order, Class)) %>%
  rename(DegreeItero = DegreeItero.x)

demo <- demostoch %>%
  mutate(simtype = "demoStoch") %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(c(Time2Ext:DegreeItero.x, shapeItero, AgeMature, simtype, SpeciesAccepted, Family, Order, Class)) %>%
  rename(DegreeItero = DegreeItero.x)


environdemo <- environ_portfolio_demo %>%
  mutate(MatrixID = as.integer(sapply(strsplit(MatrixID,"_"), `[`, 1))) %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  mutate(simtype = "environdemo") %>%
  dplyr::select(c(Time2Ext:DegreeItero.x, ShapeItero, AgeMature, simtype, SpeciesAccepted, Family, Order, Class)) %>%
  rename(shapeItero = ShapeItero) %>%  ## ShapeItero is what we want, averaged across matrices
  rename(DegreeItero = DegreeItero.x)

environ <- environ_portfolio %>%
  mutate(MatrixID = as.integer(sapply(strsplit(MatrixID,"_"), `[`, 1))) %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  mutate(simtype = "environ") %>%
  dplyr::select(c(Time2Ext:DegreeItero.x, ShapeItero, AgeMature, simtype, SpeciesAccepted, Family, Order, Class)) %>%
  rename(shapeItero = ShapeItero) %>%
  rename(DegreeItero = DegreeItero.x)


## how many species, matrices and families?
length(unique(environ$SpeciesAccepted)) ## but some species fall in different life
table(environ$SpeciesAccepted[!duplicated(environ$LH)]) ## four that fall into two 
speciesXLH <- as.matrix(table(environ$SpeciesAccepted, environ$LH))
speciesXLH[speciesXLH > 0] <- 1
speciesXLH[rowSums(speciesXLH)>1,]
length(unique(environ$Family))
table(environ$LH[!duplicated(environ$SpeciesAccepted)])


ExtProb_all <- do.call(rbind, list(Asymp, demo, environdemo, environ))



```


```{r}
ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Figure2_Env_DemoEnvSeedSeedling",Sys.Date(),".jpg", sep=""),

ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  filter(simtype %in% c("environdemo","environ")) %>%
  ## Can select any time up to 100 years
  mutate(Ext_10yrs = case_when(Time2Ext <= 10 & !is.na(Time2Ext) ~ 1,
                               Time2Ext > 10 | is.na(Time2Ext) ~ 0)) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "Fast",
                          LH %in% c("SI","SS") ~ "Slow")) %>%
  ggplot(  aes(shapeItero, Ext_10yrs, color = start, linetype = simtype))+
    geom_point(shape = "|")+
    geom_smooth(method = "glm", method.args = list(family = "binomial"),se = TRUE, alpha = 0.25)+
    theme_bw()+
    facet_grid(Pace ~ StPopSz)+
    ylab("Probability of Extinction after 10 years")+
    xlab("Shape of Reproduction")+
    scale_color_manual("Founding stage", values = c("brown","green"),
                       labels = c("Seed","Seedling"))+
    scale_linetype_manual("Simulation", values = c("solid","dashed"), 
                          labels = c("Environment","Env + Demo")) +
    geom_vline(xintercept = -0.35, linetype = "dashed", color = "black")+
    geom_vline(xintercept = 0, linetype = "dashed", color = "black")+
    scale_x_continuous(breaks = c(-0.35, -0.3,-0.2,-0.1,0,0.1),
                       labels = c("late",0.3, -0.2,-0.1,"even",0.1),
                       guide = guide_axis(angle=90)),

width=250, height=125,units='mm', dpi=300)
```



## Add and correct family names for random effects   
```{r}
summarySeedSeedling_all <- summarySeedSeedling_all %>%
  mutate(SpeciesAccepted = as.character(SpeciesAccepted)) %>%
  mutate(Family = as.character(Family)) %>%
  mutate(SpeciesAccepted = replace(SpeciesAccepted, SpeciesAccepted == "Silene Ciliata", "Silene ciliata")) %>%
  mutate(Family = replace(Family, Family == "Compositae", "Asteraceae")) %>%
  mutate(Family = replace(Family, Family == "Leguminosae", "Fabaceae")) %>%
  mutate(Family = replace(Family, Family == "Legumiosae", "Fabaceae")) %>% ## misspelling in Kummerowia striata family
  mutate(Family = replace(Family, Family == "Dipsacaceae", "Caprifoliaceae")) %>%
  mutate(Family = replace(Family, Family == "Fzcaceae", "Fucaceae")) %>%
  mutate(Family = replace(Family, Family == "Scropulariaceae", "Scrophulariaceae")) 
  
```



JAGS binomial regression with plant family as random effect for glm   
```{r}
## Test a JAGS mixed effects run    
# specify model in BUGS language   
modelSeed <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] + 
                            bPace[fs[i]] + 
                            bStoch[simtype[i]] + 
                            bStage[stage[i]] +
                            bStPopSz * PopulationSizeScaled[i] +
                            bParity[si[i]] +
                          ## Pace interactions
                            bPaceXStoch[fs[i],simtype[i]] +
                            bPaceXStage[fs[i], stage[i]] +
                            bPaceXStPopSz[fs[i]] * PopulationSizeScaled[i] +
                            bPaceXParity[fs[i], si[i]] +
                          ## Stoch interactions
                            bStochXStage[simtype[i], stage[i]] +
                            bStochXStPopSz[simtype[i]] * PopulationSizeScaled[i] +
                            bStochXParity[simtype[i], si[i]] +
                          ## Stage interactions
                            bStageXStPopSz[stage[i]] * PopulationSizeScaled[i] +
                            bStageXParity[stage[i], si[i]] +
                          ## StPopSz interaction
                            bStPopSzXParity[si[i]] * PopulationSizeScaled[i] 
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        for(i in 1:4){
          Starttemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- Starttemp - mean(Starttemp)
        
        for(i in 1:2){
          stagetemp[i] ~ dnorm(0, 0.01)
        }
        bStage <- stagetemp - mean(stagetemp)
                
        bStPopSz ~ dunif(-3,3)
        
        for(i in 1:2){
          Paritytemp[i] ~ dnorm(0, 0.01)
        }
        bParity <- Paritytemp - mean(Paritytemp)
        
      ## Pace interactions
        for(i in 1:2){
          for(j in 1:4){
            bPaceXstochtemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXStoch <- bPaceXstochtemp - mean(bPaceXstochtemp)
        
        for(i in 1:2){
          for(j in 1:2){
            pacestagetemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXStage <- pacestagetemp - mean(pacestagetemp)
        
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          for(j in 1:2){
            PaceXParitytemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXParity <- PaceXParitytemp - mean(PaceXParitytemp)
        
      ## Stoch interactions
        for(i in 1:4){
          for(j in 1:2){
            stochstage[i, j] ~ dnorm(0, 0.01)
          }
        }
        bStochXStage <- stochstage - mean(stochstage)
        
        for(i in 1:4){
          stochstpop[i] ~ dnorm(0, 0.01)
        }
        bStochXStPopSz <- stochstpop - mean(stochstpop)
        
        for(i in 1:4){
          for(j in 1:2){
            stochparity[i, j] ~ dnorm(0, 0.01)
          }
        }
        bStochXParity <- stochparity - mean(stochparity)
        
      ## Stage interactions 
        for(i in 1:2){
          stagestpop[i] ~ dnorm(0, 0.01)
        }
        bStageXStPopSz <- stagestpop - mean(stagestpop)
        
        for(i in 1:2){
          for(j in 1:2){
            stageparity[i,j] ~ dnorm(0, 0.01)
          }
        }
        bStageXParity <- stageparity - mean(stageparity)

      ## PopSz interactions       
        for(i in 1:2){
          bStParitytemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXParity <- bStParitytemp - mean(bStParitytemp)

        }")
writeLines(modelSeed, "popsizeSeedFamily.jags")
sampleSumSimSeed <- summarySeedSeedling_all[sample(1:nrow(summarySeedSeedling_all), 10000, replace = FALSE),]
sampleSumSimSeed$Family <- droplevels(as.factor(sampleSumSimSeed$Family))
jags.data <- list(y = sampleSumSimSeed$Ext_10yrs, N = nrow(sampleSumSimSeed),
                  nFam = length(unique(sampleSumSimSeed$Family)),
                  fam = sampleSumSimSeed$Family,
                  PopulationSizeScaled = sampleSumSimSeed$PopulationSizeScaled, 
                  fs = as.factor(sampleSumSimSeed$Pace),
                  si = as.factor(sampleSumSimSeed$Parity),
                  simtype = as.factor(sampleSumSimSeed$simtype),
                  stage = as.factor(sampleSumSimSeed$start))
## parameters monitored
parameters <- c("bPace","bStPopSz","bStage","bStoch","bParity",
                "bPaceXStoch","bPaceXStage","bPaceXStPopSz","bPaceXParity",
                "bStochXStage","bStochXStPopSz","bStochXParity",
                "bStageXStPopSz","bStageXParity")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 2
# call JAGS from R
resSeed <- jags(jags.data, inits = NULL, parameters, 
            "popsizeSeedFamily.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 
save(resSeed, file = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/binomialFamRndmSeed",Sys.Date(),"..Rdata", sep=""))
print(resSeed, digits = 3)
## Check convergence 
# trace plots
traplot(resSeed,c("bPace","bStPopSz","bStage","bStoch","bParity",
                "bPaceXStoch","bPaceXStage","bPaceXStPopSz","bPaceXParity",
                "bStochXStage","bStochXStPopSz","bStochXParity",
                "bStageXStPopSz","bStageXParity"))
# posterior distributions
denplot(resSeed,c("bPace","bStPopSz","bStage","bStoch","bParity",
                "bPaceXStoch","bPaceXStage","bPaceXStPopSz","bPaceXParity",
                "bStochXStage","bStochXStPopSz","bStochXParity",
                "bStageXStPopSz","bStageXParity"))
```


