---
title: "2023_EffectSize"
author: "Michelle DePrenger-Levin"
date: "2023-01-01"
output: html_document
---
##In TraitsER hackathon

```{r}
rm(list=ls()) 
library(popbio)
library(popdemo)
library(ggplot2)
library(patchwork)
library(tidyr)
library(dplyr)    
library(lme4)
library(boot)
library(sjPlot)
library(MASS)

require(AICcmodavg)

library(R2jags)
library(runjags)
library(mcmcplots)
library(boot)


fi <- "blue"
si <- "brown"
fs <- "chartreuse4"
ss <- "goldenrod3"
  
# sampling from distribution, subtraction, report the mean and SD of differences
diffProb <- function(prob1, prob2){
  ## probs = confint(x) such that [1] is 2.5% and [2] is 97.5
  samp1 <- runif(1000, prob1[1], prob1[2])
  samp2 <- runif(1000, prob2[1], prob2[2])
  m.diff <- mean(samp1-samp2)
  sd.diff <- sd(samp1-samp2)
  data.frame(m.diff, sd.diff)
}
```


1. figures of relationships of fecundity and net reproductive rates, growth rates, ...
```{r}
load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/plants_data2022-11-14.Rdata")

load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/EP_asymptotic2022-11-15.Rdata")

load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/EP_environ2022-11-16.Rdata")

load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/EP_environdemo2022-11-16.Rdata")

load("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/EP_binomPoisson2022-11-15.Rdata")
```

Distribution of data for each simulation
```{r}
EP_binomPoisson %>%
    left_join(data.frame(plants.data), by = c("MatrixID","DegreeItero")) %>%
    dplyr::select(Time2Ext:DegreeItero, shapeItero, AgeMature, MatrixID) %>%
    dplyr::rename(ShapeItero = shapeItero) %>%
    bind_rows(EP_asymptotic) %>%
    mutate(MatrixID = as.character(MatrixID)) %>%
    bind_rows(EP_environdemo) %>%
    bind_rows(EP_environ) %>%
  ggplot( aes(log(AgeMature), fill = start))+
    geom_histogram(position = position_dodge(width = 0.1), alpha = 1)
  
EP_binomPoisson %>%
    left_join(data.frame(plants.data), by = c("MatrixID","DegreeItero")) %>%
    dplyr::select(Time2Ext:DegreeItero, shapeItero, AgeMature, MatrixID) %>%
    dplyr::rename(ShapeItero = shapeItero) %>%
    bind_rows(EP_asymptotic) %>%
    mutate(MatrixID = as.character(MatrixID)) %>%
    bind_rows(EP_environdemo) %>%
    bind_rows(EP_environ) %>%
  group_by(start) %>%
  summarise(AgeMatureMedian = median(AgeMature),
            AgeMatmin = min(AgeMature),
            AgeMatmax = max(AgeMature),
            AgeMatureSD = sd(AgeMature),
            ShapeIteromean = mean(ShapeItero, na.rm = TRUE),
            ShapeIteromin = min(ShapeItero, na.rm = TRUE),
            ShapeIteromax = max(ShapeItero, na.rm = TRUE),
            ShapeIteroSD = sd(ShapeItero, na.rm = TRUE)
            )


```

<https://stackoverflow.com/questions/41384075/r-calculate-and-interpret-odds-ratio-in-logistic-regression>  

What's the slope of the lines for slow and fast (as effect size)    
The odds ratio is the effect size. Raw coefficients are on log-odds scale, exp() to get odds ratio, how many times more likely   
Simulated such a big sample size, don't need AIC for which model best fits.  
```{r}
EP_asymptotic_sp <- EP_asymptotic %>%
  mutate(MatrixID = as.numeric(MatrixID)) %>%
  left_join(data.frame(plants.data), by = c("MatrixID")) %>%
  dplyr::select(Time2Ext:LH, ShapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 
rm(EP_asymptotic)

## Where ShapeItero is the average across matrices, shapeItero from plants.data for the first matrix
EP_environ_sp <- EP_environ %>%
  mutate(MatrixID = as.numeric(sapply(strsplit(MatrixID,"_"), `[`, 1))) %>%
  left_join(data.frame(plants.data), by = c("MatrixID")) %>%
  dplyr::select(Time2Ext:LH, ShapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class))
rm(EP_environ)

## Where ShapeItero is the average across matrices, shapeItero from plants.data for the first matrix
EP_environdemo_sp <- EP_environdemo %>%
  mutate(MatrixID = as.numeric(sapply(strsplit(MatrixID,"_"), `[`, 1))) %>%
  left_join(data.frame(plants.data), by = c("MatrixID")) %>%
  dplyr::select(Time2Ext:LH, ShapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 
rm(EP_environdemo)
gc()

summarySimulations <- EP_binomPoisson %>%
    left_join(data.frame(plants.data), by = c("MatrixID")) %>% 
    dplyr::select(Time2Ext:LH, shapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) %>%
    dplyr::rename(ShapeItero = shapeItero) %>% ## Because all others come from the simulation and are ShapeItero
    bind_rows(EP_asymptotic_sp) %>%
    # mutate(MatrixID = as.character(MatrixID)) %>%
    bind_rows(EP_environdemo_sp) %>%
    bind_rows(EP_environ_sp) %>%
    mutate(Ext_10yrs = case_when(Time2Ext <= 10 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 10 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Ext_30yrs = case_when(Time2Ext <= 30 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 30 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Ext_50yrs = case_when(Time2Ext <= 50 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 50 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Ext_100yrs = case_when(Time2Ext <= 100 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 100 | is.na(Time2Ext) ~ 0)) %>%
    mutate(Pace = case_when(LH %in% c("FI","FS") ~ "Fast",
                                LH %in% c("SI","SS") ~ "Slow")) %>%
    filter(!is.na(Pace)) %>%
    dplyr::rename(PopulationSize = StPopSz) %>%
    # group_by(start) %>%
    ungroup() %>%
    mutate(StPopSzSD = sd(PopulationSize),
           StPopSzmean = mean(PopulationSize),
           ShapeIteroSD = sd(ShapeItero),
           ShapeIteromean = mean(ShapeItero),
           AgeMatureSD = sd(AgeMature),
           AgeMaturemean = mean(AgeMature))  %>%
    dplyr::mutate(PopulationSizeScaled = scale(PopulationSize)[,1],
                  ShapeIteroScaled = scale(ShapeItero)[,1],
                  AgeMatureScaled = scale(AgeMature)[,1])

hist(summarySimulations$ShapeIteroScaled)
hist(summarySimulations$ShapeItero)

par(mar = c(5.1, 4.1, 4.1, 2.1))
par(mar = c(6.7, 2.1, 1, 1))
barplot(sort(table(summarySimulations$Family[!duplicated(summarySimulations$SpeciesAccepted)])), las=2, font = 6)
summarySimulations %>%
  group_by(Family, SpeciesAccepted) %>%
  summarise(MatNum = n()) %>%
  group_by(Family) %>%
  summarise(FamNum = n()) %>%
  # filter(FamNum == 1) ## 37 families with only 1 species
  # filter(FamNum > 1)    ## 42 families with 2 or more species
  # filter(FamNum == 2)     ## 18 families with 2 species
  # filter(FamNum > 3)      ## 18 families with 3 or more species
  filter(FamNum < 3)      ## 55 families with 1 or 2 species

data.frame(sort(table(summarySimulations$Family[!duplicated(summarySimulations$SpeciesAccepted)])))


# summarySimulations$Family[summarySimulations$Family == "Leguminosae"] <- "Fabaceae"
summarySimulations <- summarySimulations %>%
  mutate(SpeciesAccepted = as.character(SpeciesAccepted)) %>%
  mutate(Family = as.character(Family)) %>%
  mutate(SpeciesAccepted = replace(SpeciesAccepted, SpeciesAccepted == "Silene Ciliata", "Silene ciliata")) %>%
  mutate(Family = replace(Family, Family == "Compositae", "Asteraceae")) %>%
  mutate(Family = replace(Family, Family == "Leguminosae", "Fabaceae")) %>%
  mutate(Family = replace(Family, Family == "Legumiosae", "Fabaceae")) %>% ## misspelling in Kummerowia striata family
  mutate(Family = replace(Family, Family == "Dipsacaceae", "Caprifoliaceae")) %>%
  mutate(Family = replace(Family, Family == "Fzcaceae", "Fucaceae")) %>%
  mutate(Family = replace(Family, Family == "Scropulariaceae", "Scrophulariaceae"))

fams <- nrow(table(summarySimulations$Family[!duplicated(summarySimulations$SpeciesAccepted)]))
barplot(sort(table(summarySimulations$Family[!duplicated(summarySimulations$SpeciesAccepted)])),# xaxt="n") #
        las=2, font = 6)



spPfam <- data.frame(sort(table(summarySimulations$Family[!duplicated(summarySimulations$SpeciesAccepted)])))
spPfam$Var1 <- factor(spPfam$Var1, levels = spPfam$Var1)

ggplot(spPfam, aes(Var1, Freq))+
  geom_bar(stat = "identity")+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  theme_bw()+
  ylab("Number of Species")+
  xlab("")
```




```{r}
plants.data %>%
  mutate(SpeciesAccepted = replace(SpeciesAccepted, SpeciesAccepted == "Silene Ciliata", "Silene ciliata")) %>%
  mutate(Family = replace(Family, Family == "Compositae", "Asteraceae")) %>%
  mutate(Family = replace(Family, Family == "Leguminosae", "Fabaceae")) %>%
  mutate(Family = replace(Family, Family == "Legumiosae", "Fabaceae")) %>% ## misspelling in Kummerowia striata family
  mutate(Family = replace(Family, Family == "Dipsacaceae", "Caprifoliaceae")) %>%
  mutate(Family = replace(Family, Family == "Fzcaceae", "Fucaceae")) %>%
  mutate(Family = replace(Family, Family == "Scropulariaceae", "Scrophulariaceae")) %>%
  group_by(Family, SpeciesAccepted, LifeHistory) %>%
  filter(!is.na(LifeHistory)) %>%
  summarise(MeanShape = mean(shapeItero, na.rm = TRUE),
         sdShape = sd(shapeItero, na.rm = TRUE),
         meanMatureage = mean(matureAge, na.rm = TRUE),
         sdMatureage = sd(matureAge),
         meanGentime = mean(gentime, na.rm = TRUE),
         sdGentime = sd(gentime, na.rm = TRUE),
         meanlongevity = mean(longevity, na.rm = TRUE),
         sdlongevity = sd(longevity, na.rm = TRUE),
         meannetReproRate = mean(netReproRate, na.rm = TRUE),
         sdnetReproRate = sd(netReproRate, na.rm = TRUE),
         meanremainingAgeMature = mean(remainingAgeMature, na.rm = TRUE),
         sdremainingAgeMature = sd(remainingAgeMature, na.rm = TRUE),
         MatNum = n()) %>%
  filter(!is.na(MeanShape)) %>%
  arrange(MeanShape, MatNum, Family, SpeciesAccepted) %>%
  write.csv(., file = paste("/Rdatas/plants_summaryShapesort",Sys.Date(),".csv", sep=""))
```

## JAGS with group effect of family    
```{r}
# specify model in BUGS language   
model10year <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] + 
                            bPace[fs[i]] + 
                            bStoch[start[i]] + 
                            bStPopSz * PopulationSizeScaled[i] +
                            bShapeItero * shapeI[i] +
                            bPaceXStPopSz[fs[i]] * PopulationSizeScaled[i] +
                            bPaceXShape[fs[i]] * shapeI[i] +
                            bPaceXstart[fs[i],start[i]] +
                            bStPopSzXShape * PopulationSizeScaled[i] * shapeI[i] +
                            bStPopSzXStart[start[i]] * PopulationSizeScaled[i] +
                            bShapeXStart[start[i]] * shapeI[i]
                            
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        ## also index for the interactions!
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          PaceXShapetemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        
        for(i in 1:4){
          Starttemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- Starttemp - mean(Starttemp)
        

        for(i in 1:2){
          for(j in 1:4){
            bPaceXstarttemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXstart <- bPaceXstarttemp - mean(bPaceXstarttemp)
        
        # bStPopSzXStart
        for(i in 1:4){
          bStSttemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStart <- bStSttemp - mean(bStSttemp)
        
        # bShapeXStart
        for(i in 1:4){
          bShSttemp[i] ~ dnorm(0, 0.01)
        }
        bShapeXStart <- bShSttemp - mean(bShSttemp)
        
        bStPopSz ~ dunif(-3,3)
        bShapeItero ~ dunif(-3,3)
        bStPopSzXShape ~ dunif(-5,5)
        
        }")
writeLines(model10year, "popsize10yrsFamily.jags")

jags.data <- list(y = summarySimulations$Ext_10yrs, N = nrow(summarySimulations),
                  nFam = length(unique(summarySimulations$Family)),
                  fam = as.factor(summarySimulations$Family),
                  PopulationSizeScaled = summarySimulations$PopulationSizeScaled,
                  fs = as.factor(summarySimulations$Pace),
                  shapeI = summarySimulations$ShapeIteroScaled,
                  start = as.factor(summarySimulations$start))

## parameters monitored
parameters <- c("bPace","bStPopSz","bShapeItero","bStoch",
                "bPaceXStPopSz","bPaceXShape","bPaceXstart","bShapeXStart",
                "bStPopSzXStart","bStPopSzXShape")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res1 <- jags(jags.data, inits = NULL, parameters, 
            "popsize10yrsFamily.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 

save(res1, file = paste("/Rdatas/binomialFamRndm10yrs_SSD10000sample1",Sys.Date(),".Rdata", sep=""))

```


100 years
```{r}
# specify model in BUGS language   
model100year <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] + 
                            bPace[fs[i]] + 
                            bStoch[start[i]] + 
                            bStPopSz * PopulationSizeScaled[i] +
                            bShapeItero * shapeI[i] +
                            bPaceXStPopSz[fs[i]] * PopulationSizeScaled[i] +
                            bPaceXShape[fs[i]] * shapeI[i] +
                            bPaceXstart[fs[i],start[i]] +
                            bStPopSzXShape * PopulationSizeScaled[i] * shapeI[i] +
                            bStPopSzXStart[start[i]] * PopulationSizeScaled[i] +
                            bShapeXStart[start[i]] * shapeI[i]
                            
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        ## also index for the interactions!
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          PaceXShapetemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        
        for(i in 1:4){
          Starttemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- Starttemp - mean(Starttemp)
        

        for(i in 1:2){
          for(j in 1:4){
            bPaceXstarttemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXstart <- bPaceXstarttemp - mean(bPaceXstarttemp)
        
        # bStPopSzXStart
        for(i in 1:4){
          bStSttemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStart <- bStSttemp - mean(bStSttemp)
        
        # bShapeXStart
        for(i in 1:4){
          bShSttemp[i] ~ dnorm(0, 0.01)
        }
        bShapeXStart <- bShSttemp - mean(bShSttemp)
        
        bStPopSz ~ dunif(-3,3)
        bShapeItero ~ dunif(-3,3)
        bStPopSzXShape ~ dunif(-5,5)
        
        }")
writeLines(model100year, "popsize100yrsFamily.jags")

jags.data <- list(y = summarySimulations$Ext_10yrs, N = nrow(summarySimulations),
                  nFam = length(unique(summarySimulations$Family)),
                  fam = as.factor(summarySimulations$Family),
                  PopulationSizeScaled = summarySimulations$PopulationSizeScaled,
                  fs = as.factor(summarySimulations$Pace),
                  shapeI = summarySimulations$ShapeIteroScaled,
                  start = as.factor(summarySimulations$start))

## parameters monitored
parameters <- c("bPace","bStPopSz","bShapeItero","bStoch",
                "bPaceXStPopSz","bPaceXShape","bPaceXstart","bShapeXStart",
                "bStPopSzXStart","bStPopSzXShape")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res100 <- jags(jags.data, inits = NULL, parameters, 
            "popsize100yrsFamily.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 

save(res100, file = paste("/Rdatas/binomialFamRndm100yrs_SSD",Sys.Date(),"..Rdata", sep=""))
print(res100, digits = 3)
## Check convergence 
# trace plots
traplot(res100,c("bPace","bStPopSz","bShapeItero","bStoch",
                "bPaceXStPopSz","bPaceXShape","bPaceXstart","bShapeXStart",
                "bStPopSzXStart","bStPopSzXShape"))
# posterior distributions
denplot(res100,c("bPace","bStPopSz","bShapeItero","bStoch",
                "bPaceXStPopSz","bPaceXShape","bPaceXstart","bShapeXStart",
                "bStPopSzXStart","bStPopSzXShape"))
```

## Test 10 years without group effect of family    
```{r}
# specify model in BUGS language   
model10yearsimple <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- bPace[fs[i]] + 
                            bStoch[start[i]] + 
                            bStPopSz * PopulationSizeScaled[i] +
                            bShapeItero * shapeI[i] +
                            bPaceXStPopSz[fs[i]] * PopulationSizeScaled[i] +
                            bPaceXShape[fs[i]] * shapeI[i] +
                            bPaceXstart[fs[i],start[i]] +
                            bStPopSzXShape * PopulationSizeScaled[i] * shapeI[i] +
                            bStPopSzXStart[start[i]] * PopulationSizeScaled[i] +
                            bShapeXStart[start[i]] * shapeI[i]
                            
          }
        
        # Priors 
        # mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        # sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        # tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        # for(i in 1:nFam){
        #   b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        # }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        ## also index for the interactions!
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          PaceXShapetemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        
        for(i in 1:4){
          Starttemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- Starttemp - mean(Starttemp)
        

        for(i in 1:2){
          for(j in 1:4){
            bPaceXstarttemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXstart <- bPaceXstarttemp - mean(bPaceXstarttemp)
        
        # bStPopSzXStart
        for(i in 1:4){
          bStSttemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStart <- bStSttemp - mean(bStSttemp)
        
        # bShapeXStart
        for(i in 1:4){
          bShSttemp[i] ~ dnorm(0, 0.01)
        }
        bShapeXStart <- bShSttemp - mean(bShSttemp)
        
        bStPopSz ~ dunif(-3,3)
        bShapeItero ~ dunif(-3,3)
        bStPopSzXShape ~ dunif(-5,5)
        
        }")
writeLines(model10yearsimple, "popsize10yrssimple.jags")

jags.data <- list(y = summarySimulations$Ext_10yrs, N = nrow(summarySimulations),
                  nFam = length(unique(summarySimulations$Family)),
                  fam = as.factor(summarySimulations$Family),
                  PopulationSizeScaled = summarySimulations$PopulationSizeScaled,
                  fs = as.factor(summarySimulations$Pace),
                  shapeI = summarySimulations$ShapeIteroScaled,
                  start = as.factor(summarySimulations$start))

## parameters monitored
parameters <- c("bPace","bStPopSz","bShapeItero","bStoch",
                "bPaceXStPopSz","bPaceXShape","bPaceXstart","bShapeXStart",
                "bStPopSzXStart","bStPopSzXShape")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res10 <- jags(jags.data, inits = NULL, parameters, 
            "popsize10yrssimple.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 

save(res10, file = paste("/Rdatas/binomialsimple10yrs_SSD",Sys.Date(),".Rdata", sep=""))
print(res10, digits = 3)
## Check convergence 
# trace plots
traplot(res10,c("bPace","bStPopSz","bShapeItero","bStoch","bPaceXStPopSz","bPaceXShape","bStPopSzXShape","bPaceXstart","bStPopSzXStart"))
# posterior distributions
denplot(res10,c("bPace","bStPopSz","bShapeItero","bStoch","bPaceXStPopSz","bPaceXShape","bStPopSzXShape","bPaceXstart","bStPopSzXStart"))
```


### seed or seedlings, effect sizes of mode of reproduction, pace, and population size. 

```{r}

load("/Rdatas/plants_data.Rdata")
## Sample plants.seedbank asymptotic. 2022_SimulationDemoDistriubtion.Rmd   
load("/Rdatas/Time2Ext_Asymptotic.Rdata")
## Sample plants.seedbank demographic stochastic (binomial and Poisson). 2022_SimulationDemoBinomialPoisson.Rmd
load("/Rdatas/Time2Ext_demostoch.Rdata")
## sample species with different matrices without demo stoch. 2022_SimulationEnvDistribution.Rmd
load("/Rdatas/Time2Ext_environ.Rdata") 
## Sample species and run all matrices of a life history with demo stoch
load("/Rdatas/Time2Ext_environ-demo.Rdata")


Asymp <- Time2Ext_EP %>% ## Missing ShapeItero, need to pull shapeItero from plants.data
  mutate(simtype = "Asymptotic") %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(Time2Ext:LH, shapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class, simtype) %>%
  rename(ShapeItero = shapeItero) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 

demo <- demostoch %>% ## Missing ShapeItero, need to pull from plants.data
  mutate(simtype = "demoStoch") %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(Time2Ext:LH, shapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class, simtype) %>%
  rename(ShapeItero = shapeItero) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 

environdemo <- environ_portfolio_demo %>%
  mutate(simtype = "environdemo") %>%
  mutate(MatrixID = as.numeric(sapply(strsplit(MatrixID,"_"), `[`, 1))) %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(Time2Ext:LH, ShapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class, simtype) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 

environ <- environ_portfolio %>%
  mutate(simtype = "environ") %>%
  mutate(MatrixID = as.numeric(sapply(strsplit(MatrixID,"_"), `[`, 1))) %>%
  left_join(data.frame(plants.data), by = "MatrixID") %>%
  dplyr::select(Time2Ext:LH, ShapeItero, AgeMature, MatrixID, SpeciesAccepted, Family, Order, Class, simtype) %>%
  mutate(SpeciesAccepted = as.factor(SpeciesAccepted),
         Family = as.factor(Family),
         Order = as.factor(Order),
         Class = as.factor(Class)) 

ExtProb_all <- do.call(rbind, list(Asymp, demo, environdemo, environ))

```


## make a time to extinction dataframe to use. 

```{r}
summarySeedSeedling <- ExtProb_all %>%
  mutate(Parity = case_when(LH %in% c("FI","SI") ~ "itero",
                            LH %in% c("FS","SS") ~ "semel")) %>%
  mutate(Pace = case_when(LH %in% c("FI","FS") ~ "fast",
                            LH %in% c("SS","SI") ~ "slow")) %>%
  filter(simtype %in% c("environdemo","environ")) %>%
  # filter(simtype %in% c("environdemo","demoStoch")) %>%
  group_by(LH, start, simtype, StPopSz, Parity, Pace, Family) %>%
    mutate(Ext_10yrs = case_when(Time2Ext <= 10 & !is.na(Time2Ext) ~ 1,
                                 Time2Ext > 10 | is.na(Time2Ext) ~ 0)) 

```


10 years
```{r}
# specify model in BUGS language   
model10yearSeed <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] +                     ## Random effect of family
                            bPace[Pace[i]] +                      ## Pace: fast age of rep < 3yrs or slow age of rep 3+
                            bParity[Parity[i]] +                  ## Parity: iteroparous 3+ yrs rep, semelparous <3 yrs
                            bStoch[simtype[i]] +                  ## stochasticity: Asymptotic, demographic, [1] environ [2] environdemo 
                            bStPopSz * StPopSz[i] +               ## founding population size: 1,10,50,100,1000
                            bStage[start[i]] +                    ## founding population stage: seed, seedling 
                            ## Interactions
                            bPaceXParity[Pace[i],Parity[i]] +
                            bPaceXStoch[Pace[i],simtype[i]] +
                            bPaceXStPopSz[Pace[i]] * StPopSz[i] + 
                            bPaceXStage[Pace[i],start[i]] +
                            
                            bParityXStoch[Parity[i],simtype[i]] +
                            bParityXStPopSz[Parity[i]] * StPopSz[i] + 
                            bParityXStage[Parity[i],start[i]] +
                            
                            bStageXStoch[start[i],simtype[i]] +
                            bStageXStPopSz[start[i]] * StPopSz[i] +
                            
                            bStPopSzXStoch[simtype[i]] * StPopSz[i]
                            
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        for(i in 1:2){
          Paritytemp[i] ~ dnorm(0, 0.01)
        }
        bParity <- Paritytemp - mean(Paritytemp) ## change in centered Pace
                
        for(i in 1:4){
          simtypetemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- simtypetemp - mean(simtypetemp)

        for(i in 1:2){
          Stagetemp[i] ~ dnorm(0, 0.01)
        }
        bStage <- Stagetemp - mean(Stagetemp)
        
        for(i in 1:2){
          for(j in 1:2){
            PaceParitytemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bPaceXParity <- PaceParitytemp - mean(PaceParitytemp)
        
        for(i in 1:2){
          for(j in 1:2){
            bPaceXStochtemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXStoch <- bPaceXStochtemp - mean(bPaceXStochtemp)

        for(i in 1:2){
          for(j in 1:2){
            bParityXStochtemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bParityXStoch <- bParityXStochtemp - mean(bParityXStochtemp)
        
        for(i in 1:2){
          for(j in 1:2){
            PaceStagetemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bPaceXStage <- PaceStagetemp - mean(PaceStagetemp)
        
        
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          PaceXShapetemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        for(i in 1:2){
          ParityXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bParityXStPopSz <- ParityXStPopSztemp - mean(ParityXStPopSztemp)
        
        for(i in 1:2){
          for(j in 1:2){
            ParityStagetemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bParityXStage <- ParityStagetemp - mean(ParityStagetemp)
         
        for(i in 1:2){
          for(j in 1:2){
            StageXStochtemp[i,j] ~ dnorm(0,0.01)
          }
        }
        bStageXStoch <- StageXStochtemp - mean(StageXStochtemp)
        
        for(i in 1:2){
          StageXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bStageXStPopSz <- StageXStPopSztemp - mean(StageXStPopSztemp)
        
        for(i in 1:2){
          StPopSzXStochtemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStoch <- StPopSzXStochtemp - mean(StPopSzXStochtemp)
        
        bStPopSz ~ dunif(-3,3)
        
        }")
writeLines(model10yearSeed, "popsize10yrsFamilyseed.jags")

jags.dataseed <- list(y = summarySeedSeedling_v2$Ext_10yrs, N = nrow(summarySeedSeedling_v2),
                      nFam = length(unique(summarySeedSeedling_v2$Family)),
                      fam = as.factor(summarySeedSeedling_v2$Family),
                      StPopSz = summarySeedSeedling_v2$StPopSz,                     ## continuous, scaled and centered
                      Pace = as.factor(summarySeedSeedling_v2$Pace),                ## [1] fast [2] slow
                      Parity = summarySeedSeedling_v2$ParityScaled,                 ## [1] itero [2] semel
                      start = as.factor(sampleSeed$start),                          ## [1] seed [2] seedling
                      simtype = as.factor(summarySeedSeedling_v2$simtype))          ## [1] environ [2] environdemo

## parameters monitored
parameters <- c("bPace","bParity","bStoch","bStPopSz","bStage",
                "bPaceXParity","bPaceXStoch","bPaceXStPopSz","bPaceXStage",
                "bParityXStoch","bParityXStPopSz","bParityXStage",
                "bStageXStoch","bStageXStPopSz",
                "bStPopSzXStoch")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res10seed <- jags(jags.dataseed, inits = NULL, parameters, 
            "popsize10yrsFamilyseed.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 
## misnamed res100
save(res10seed, file = paste("/Rdatas/binomialFamRndm10yrs_seed",Sys.Date(),"..Rdata", sep=""))
print(res10seed, digits = 3)
## Check convergence 
# trace plots
traplot(res100, c("bPace","bParity","bStoch","bStPopSz","bStage",
                "bPaceXParity","bPaceXStoch","bPaceXStPopSz","bPaceXStage",
                "bParityXStoch","bParityXStPopSz","bParityXStage",
                "bStageXStoch","bStageXStPopSz",
                "bStPopSzXStoch"))
# posterior distributions
denplot(res100, c("bPace","bParity","bStoch","bStPopSz","bStage",
                "bPaceXParity","bPaceXStoch","bPaceXStPopSz","bPaceXStage",
                "bParityXStoch","bParityXStPopSz","bParityXStage",
                "bStageXStoch","bStageXStPopSz",
                "bStPopSzXStoch"))
```







# AIC of mulitple models  test with sample  
```{r}
set.seed(232323)

# specify model in BUGS language   
model10year <- 
  paste("
      model {
        # Likelihood:
          for(i in 1:N){
            y[i] ~ dbern(p[i])
            logit(p[i]) <- b0Family[fam[i]] + 
                            bPace[fs[i]] + 
                            bStoch[start[i]] + 
                            bStPopSz * PopulationSizeScaled[i] +
                            bShapeItero * shapeI[i] +
                            bPaceXStPopSz[fs[i]] * PopulationSizeScaled[i] +
                            bPaceXShape[fs[i]] * shapeI[i] +
                            bPaceXstart[fs[i],start[i]] +
                            bStPopSzXShape * PopulationSizeScaled[i] * shapeI[i] +
                            bStPopSzXStart[start[i]] * PopulationSizeScaled[i] +
                            bShapeXStart[start[i]] * shapeI[i]
                            
          }
        
        # Priors 
        mu_int ~ dnorm(0, 0.0001) # mean hyperparameter for random intercepts
        sigma_int ~ dunif(0,100)  # SD hyperparameter for random intercepts
        tau_int <- 1/(sigma_int * sigma_int)  ## precision
        ## Random effect of Family
        for(i in 1:nFam){
          b0Family[i] ~ dnorm(mu_int, tau_int) ##Random intercepts
        }
        
        for(i in 1:2){
          Pacetemp[i] ~ dnorm(0, 0.01)
        }
        bPace <- Pacetemp - mean(Pacetemp) ## change in centered Pace
        
        ## also index for the interactions!
        for(i in 1:2){
          PaceXStPopSztemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXStPopSz <- PaceXStPopSztemp - mean(PaceXStPopSztemp)
        
        for(i in 1:2){
          PaceXShapetemp[i] ~ dnorm(0, 0.01)
        }
        bPaceXShape <- PaceXShapetemp - mean(PaceXShapetemp)
        
        
        for(i in 1:4){
          Starttemp[i] ~ dnorm(0, 0.01)
        }
        bStoch <- Starttemp - mean(Starttemp)
        

        for(i in 1:2){
          for(j in 1:4){
            bPaceXstarttemp[i,j] ~ dnorm(0, 0.01)
          }
        }
        bPaceXstart <- bPaceXstarttemp - mean(bPaceXstarttemp)
        
        # bStPopSzXStart
        for(i in 1:4){
          bStSttemp[i] ~ dnorm(0, 0.01)
        }
        bStPopSzXStart <- bStSttemp - mean(bStSttemp)
        
        # bShapeXStart
        for(i in 1:4){
          bShSttemp[i] ~ dnorm(0, 0.01)
        }
        bShapeXStart <- bShSttemp - mean(bShSttemp)
        
        bStPopSz ~ dunif(-3,3)
        bShapeItero ~ dunif(-3,3)
        bStPopSzXShape ~ dunif(-5,5)
        
        }")
writeLines(model10year, "popsize10yrsFamily.jags")


sampleSumSim <- summarySimulations[sample(1:nrow(summarySimulations), 1000, replace = FALSE),]
sampleSumSim$Family <- droplevels(as.factor(sampleSumSim$Family))
jags.data <- list(y = sampleSumSim$Ext_10yrs, N = nrow(sampleSumSim),
                  nFam = length(unique(sampleSumSim$Family)),
                  fam = sampleSumSim$Family,
                  PopulationSizeScaled = sampleSumSim$PopulationSizeScaled, fs = as.factor(sampleSumSim$Pace),
                  shapeI = sampleSumSim$ShapeIteroScaled,
                  start = as.factor(sampleSumSim$start))
# jags.data <- list(y = summarySimulations$Ext_10yrs, N = nrow(summarySimulations),
#                   nFam = length(unique(summarySimulations$Family)),
#                   fam = as.factor(summarySimulations$Family),
#                   PopulationSizeScaled = summarySimulations$PopulationSizeScaled,
#                   fs = as.factor(summarySimulations$Pace),
#                   shapeI = summarySimulations$ShapeIteroScaled,
#                   start = as.factor(summarySimulations$start))

## parameters monitored
parameters <- c("bPace","bStPopSz","bShapeItero","bStoch",
                "bPaceXStPopSz","bPaceXShape","bPaceXstart","bShapeXStart",
                "bStPopSzXStart","bStPopSzXShape")
# MCMC settings
ni <- 10000
nt <- 6
nb <- 5000
nc <- 3
# call JAGS from R
res <- jags(jags.data, inits = NULL, parameters, 
            "popsize10yrsFamily.jags", n.chains = nc, n.thin = nt, 
            n.iter = ni, n.burnin = nb,
            working.directory = getwd()) 

save(res, file = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/binomialFamRndm10yrs_SSD",Sys.Date(),"..Rdata", sep=""))
print(res, digits = 3)
## Check convergence 
# trace plots
traplot(res,c("bPace","bStPopSz","bShapeItero","bStoch","bPaceXStPopSz","bPaceXShape","bStPopSzXShape","bPaceXstart","bStPopSzXStart"))
# posterior distributions
denplot(res,c("bPace","bStPopSz","bShapeItero","bStoch","bPaceXStPopSz","bPaceXShape","bStPopSzXShape","bPaceXstart","bStPopSzXStart"))

dic.pd <- dic.samples(res$model, 1000, "pD") ## differs from before, has NA warning error
```

